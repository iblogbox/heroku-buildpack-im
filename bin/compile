#!/usr/bin/env bash

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2

S3_BASE="https://s3-eu-west-1.amazonaws.com/heroku.repixl.com"

mkdir -p "$BUILD_DIR/vendor"

install_dependency() {
  tarball="$1"
  cachepath="$CACHE_DIR/$tarball"
  vendorpath=$(echo $tarball | sed 's/\.tgz//')
  depname=$(echo $tarball | sed 's/-.*\.tgz//')
  if [ ! -r "$cachepath" ]; then
    echo "-----> Installing $depname"
    echo "       Downloading: $tarball"
    mkdir -p $(dirname $cachepath)
    curl --silent --show-error  -o $cachepath "$S3_BASE/$tarball"
  else
    echo "-----> Using cached $depname"
  fi
  mkdir -p "$BUILD_DIR/vendor/$vendorpath"
  tar -xzf $cachepath -C "$BUILD_DIR/vendor/$vendorpath"
}

install_dependency "ImageMagick-6.9.3-2.tgz"
install_dependency "LibRaw-0.17.1.tgz"
install_dependency "exiftool-10.10.tgz"

PROFILE_PATH="$BUILD_DIR/.profile.d/raw.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo "export PATH=/app/vendor/LibRaw-0.17.1/bin:\$PATH" >> $PROFILE_PATH
echo "export PATH=/app/vendor/exiftool-10.10:\$PATH" >> $PROFILE_PATH
echo "export PATH=/app/vendor/ImageMagick-6.9.3-2/bin:\$PATH" >> $PROFILE_PATH
echo "export LD_LIBRARY_PATH=/app/vendor/LibRaw-0.17.1/lib:\$LD_LIBRARY_PATH" >> $PROFILE_PATH
echo "export LD_LIBRARY_PATH=/app/vendor/ImageMagick-6.9.3-2/lib:\$LD_LIBRARY_PATH" >> $PROFILE_PATH



BUILD_DIR="$1"
SOURCE_DIR="$(dirname $0)/../compiled"
TARGET_DIR="$BUILD_DIR/vendor/im"

echo "-----> Copying files to $TARGET_DIR"

mkdir -p "$TARGET_DIR"

# chmod +x "$SOURCE_DIR/anim_diff"
# cp "$SOURCE_DIR/anim_diff" "$TARGET_DIR"

# chmod +x "$SOURCE_DIR/cwebp"
# cp "$SOURCE_DIR/cwebp" "$TARGET_DIR"

# chmod +x "$SOURCE_DIR/dwebp"
# cp "$SOURCE_DIR/dwebp" "$TARGET_DIR"

# chmod +x "$SOURCE_DIR/gif2webp"
# cp "$SOURCE_DIR/gif2webp" "$TARGET_DIR"

# chmod +x "$SOURCE_DIR/JxrDecApp"
# cp "$SOURCE_DIR/JxrDecApp" "$TARGET_DIR"

# chmod +x "$SOURCE_DIR/JxrEncApp"
# cp "$SOURCE_DIR/JxrEncApp" "$TARGET_DIR"

# chmod +x "$SOURCE_DIR/vwebp"
# cp "$SOURCE_DIR/vwebp" "$TARGET_DIR"

# chmod +x "$SOURCE_DIR/webpmux"
# cp "$SOURCE_DIR/webpmux" "$TARGET_DIR"

chmod +x "$SOURCE_DIR/bpgdec"
cp "$SOURCE_DIR/bpgdec" "$TARGET_DIR"
cp "$SOURCE_DIR/libpng16.so.16.18.0" "$TARGET_DIR"
cp "$SOURCE_DIR/libpng16.so.16" "$TARGET_DIR"
cp "$SOURCE_DIR/libpng16.so" "$TARGET_DIR"

# update PATH and LD_LIBRARY_PATH
echo "-----> Updating environment variables"
PROFILE_PATH="$BUILD_DIR/.profile.d/im.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo "export PATH=/app/vendor/im:\$PATH" >> $PROFILE_PATH
echo "export LD_LIBRARY_PATH=/app/vendor/im:\$LD_LIBRARY_PATH" >> $PROFILE_PATH

